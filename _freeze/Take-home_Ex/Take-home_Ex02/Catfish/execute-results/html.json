{
  "hash": "79b6b7742bbc341ca34c0c695005d913",
  "result": {
    "markdown": "---\ntitle: \"Catfish\"\ndate-modified: \"2023-05-23\"\nexecute:\n  echo: true\n  eval: true\n  warning: false\n  freeze: true\neditor: visual\n---\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(jsonlite, igraph, tidygraph, ggraph, \n               visNetwork, lubridate, clock,\n               tidyverse, graphlayouts)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmc2catfish_data <- fromJSON(\"data/catfish.json\")\n```\n:::\n\n\nData Wrangling\n\nExtracting the nodes\n\nThe code chunk is used to extract nodes data table from mc2_data list object and save the output in a tibble data frame object called mc2_nodes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmc2catfish_nodes <- as_tibble(mc2catfish_data$nodes) %>%\n  select(id, shpcountry, rcvcountry)\n```\n:::\n\n\n\nExtracting the edges\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmc2catfish_edges <- as_tibble(mc2catfish_data$links) %>%\n  mutate(ArrivalDate = ymd(arrivaldate)) %>%\n  mutate(Year = year(ArrivalDate)) %>%\n  select(source, target, ArrivalDate, Year, hscode, valueofgoods_omu) %>% \n  distinct()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhscodes_filtered <- c(\"302100\", \"304100\", \"303100\", \"303910\", \"160414\",\"305400\", \"305200\", \"306130\", \"306170\", \"306230\",\"306190\", \"160520\", \"307110\", \"307990\", \"307190\", \"160550\")\n\nmc2catfish_edges_aggregated <- mc2catfish_edges %>%\n  #filter(substr(as.character(hscode), 1, 4) %in% hscodes_filtered) %>%\n  #filter(hscode %in% hscodes_filtered) %>%\n  group_by(source, target, hscode, Year) %>%\n    summarise(weights = n()) %>%\n  filter(source!=target) %>%\n  filter(weights > 1) %>%\n  ungroup()\n```\n:::\n\n\nPreparing nodes data\n\nInstead of using the nodes data table extracted from mc2_data, we will prepare a new nodes data table by using the source and target fields of mc2_edges_aggregated data table. This is necessary to ensure that the nodes in nodes data tables include all the source and target values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nid1 <- mc2catfish_edges_aggregated %>%\n  select(source) %>%\n  rename(id = source)\nid2 <- mc2catfish_edges_aggregated %>%\n  select(target) %>%\n  rename(id = target)\nmc2catfish_nodes_extracted <- rbind(id1, id2) %>%\n  distinct()\n```\n:::\n\n\n\nBuilding the tidy graph data model\n\nThe following code chunk is used\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmc2catfish_graph <- tbl_graph(nodes = mc2catfish_nodes_extracted,\n                       edges = mc2catfish_edges_aggregated,\n                       directed = TRUE)\n\nmc2catfish_graph\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tbl_graph: 14 nodes and 7 edges\n#\n# A rooted forest with 7 trees\n#\n# A tibble: 14 × 1\n  id                                     \n  <chr>                                  \n1 Aqua Azul LC International             \n2 French Crab S.p.A. Worldwide           \n3 Himachal Pradesh   S.A. de C.V. America\n4 Maharashtra   Limited Liability Company\n5 Nile   S.A. de C.V.                    \n6 Olas del Sur Sea                       \n# ℹ 8 more rows\n#\n# A tibble: 7 × 5\n   from    to hscode  Year weights\n  <int> <int>  <int> <dbl>   <int>\n1     1     8  30617  2034       2\n2     2     9 841810  2034       5\n3     3    10 220300  2034       2\n# ℹ 4 more rows\n```\n:::\n:::\n\n\nVisualising the network graph\n\nThe following code chunk is used to plot the network graph\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggraph(mc2catfish_graph,\n       layout = \"fr\") +\n  geom_edge_link(aes()) +\n  geom_node_point(aes()) +\n  theme_graph()\n```\n\n::: {.cell-output-display}\n![](Catfish_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ng <- ggraph(mc2catfish_graph, \n            layout = \"nicely\") + \n  geom_edge_link(aes()) +\n  geom_node_point(aes(colour = id, \n                      size = 8))\n\ng + theme_graph()\n```\n\n::: {.cell-output-display}\n![](Catfish_files/figure-html/unnamed-chunk-9-1.png){width=1728}\n:::\n:::\n\n\n\nIn-betweeness check\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng <- mc2catfish_graph %>%\n  mutate(betweenness_centrality = centrality_betweenness()) %>%\n  ggraph(layout = \"fr\") + \n  geom_edge_link(aes(width=weights), \n                 alpha=0.2) +\n  scale_edge_width(range = c(0.1, 5)) +\n  geom_node_point(aes(colour = id,\n            size=betweenness_centrality))\ng + theme_graph()\n```\n\n::: {.cell-output-display}\n![](Catfish_files/figure-html/unnamed-chunk-10-1.png){width=1728}\n:::\n:::\n\n\n\n\nInteractive Network Diagram\n\nBefore we can plot the interactive network graph, we need to prepare the data model by using the code chunk below.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmc2catfish_edges_aggregated <- mc2catfish_edges %>%\n  left_join(mc2catfish_nodes, by = c(\"source\" = \"id\")) %>%\n  rename(from = source) %>%\n  left_join(mc2catfish_nodes, by = c(\"target\" = \"id\")) %>%\n  rename(to = target) %>%\n  #filter(MainSubject == \"Work related\") %>%\n  group_by(from, to) %>%\n    summarise(weight = n()) %>%\n  filter(from!=to) %>%\n  filter(weight > 1) %>%\n  ungroup()\n```\n:::\n\n\n\n\n\n\n\n#Testing\n\n::: {.cell}\n\n```{.r .cell-code}\n# Generate a continuous color palette with 400 colors\nnum_colors <- 14\ncolor_palette <- colorRampPalette(c(\"red\", \"blue\"))(num_colors)\n\n# Assign colors to the \"color\" attribute in the node data\nmc2catfish_nodes_extracted$color <- color_palette\n\n# Plot the network with different colors for nodes\nvisNetwork(mc2catfish_nodes_extracted, mc2catfish_edges_aggregated) %>%\n  visIgraphLayout(layout = \"layout_with_fr\") %>%\n  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%\n  visLegend() %>%\n  visLayout(randomSeed = 123)\n```\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"visNetwork html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-c2110cfad5b8d5ea4b3b\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-c2110cfad5b8d5ea4b3b\">{\"x\":{\"nodes\":{\"id\":[\"Aqua Azul LC International\",\"French Crab S.p.A. Worldwide\",\"Himachal Pradesh   S.A. de C.V. America\",\"Maharashtra   Limited Liability Company\",\"Nile   S.A. de C.V.\",\"Olas del Sur Sea\",\"Water World Pic Cargo\",\"Arunachal Pradesh s Brine\",\"Saltwater Supreme ОАО Forwading\",\"Isla del Tesoro GmbH & Co. KG Chart\",\"Sailors and Surfers Incorporated Enterprises\",\"Caracola del Sol Services\",\"Greek Sea Bass LLC\",\"Bihar  GmbH & Co. KG Carriers\"],\"color\":[\"#FF0000\",\"#EB0013\",\"#D70027\",\"#C4003A\",\"#B0004E\",\"#9C0062\",\"#890075\",\"#750089\",\"#62009C\",\"#4E00B0\",\"#3A00C4\",\"#2700D7\",\"#1300EB\",\"#0000FF\"],\"x\":[1,0.0322095167207126,0.648645805877786,-0.977556865871075,0.341996171237106,-0.647470925046301,-0.468727367278479,0.883274496782126,0.0164373370885993,0.873997104106936,-1,0.00173819975009359,-0.914372014780536,-0.129924736172397],\"y\":[0.176596410784712,-0.232109320826864,-0.775183637240675,-0.081231963200031,0.933292674515133,0.769899835330813,-0.899989536136071,0.492617391762662,0.105044130878422,-0.515603729727686,-0.410620442451139,1,0.559608941607711,-1],\"label\":[\"Aqua Azul LC International\",\"French Crab S.p.A. Worldwide\",\"Himachal Pradesh   S.A. de C.V. America\",\"Maharashtra   Limited Liability Company\",\"Nile   S.A. de C.V.\",\"Olas del Sur Sea\",\"Water World Pic Cargo\",\"Arunachal Pradesh s Brine\",\"Saltwater Supreme ОАО Forwading\",\"Isla del Tesoro GmbH & Co. KG Chart\",\"Sailors and Surfers Incorporated Enterprises\",\"Caracola del Sol Services\",\"Greek Sea Bass LLC\",\"Bihar  GmbH & Co. KG Carriers\"]},\"edges\":{\"from\":[\"Aqua Azul LC International\",\"French Crab S.p.A. Worldwide\",\"Himachal Pradesh   S.A. de C.V. America\",\"Maharashtra   Limited Liability Company\",\"Nile   S.A. de C.V.\",\"Olas del Sur Sea\",\"Water World Pic Cargo\"],\"to\":[\"Arunachal Pradesh s Brine\",\"Saltwater Supreme ОАО Forwading\",\"Isla del Tesoro GmbH & Co. KG Chart\",\"Sailors and Surfers Incorporated Enterprises\",\"Caracola del Sol Services\",\"Greek Sea Bass LLC\",\"Bihar  GmbH & Co. KG Carriers\"],\"weight\":[2,7,2,3,2,2,2]},\"nodesToDataframe\":true,\"edgesToDataframe\":true,\"options\":{\"width\":\"100%\",\"height\":\"100%\",\"nodes\":{\"shape\":\"dot\",\"physics\":false},\"manipulation\":{\"enabled\":false},\"edges\":{\"smooth\":false},\"physics\":{\"stabilization\":false},\"layout\":{\"randomSeed\":123}},\"groups\":null,\"width\":null,\"height\":null,\"idselection\":{\"enabled\":true,\"style\":\"width: 150px; height: 26px\",\"useLabels\":true,\"main\":\"Select by id\"},\"byselection\":{\"enabled\":false,\"style\":\"width: 150px; height: 26px\",\"multiple\":false,\"hideColor\":\"rgba(200,200,200,0.5)\",\"highlight\":false},\"main\":null,\"submain\":null,\"footer\":null,\"background\":\"rgba(0, 0, 0, 0)\",\"igraphlayout\":{\"type\":\"square\"},\"highlight\":{\"enabled\":true,\"hoverNearest\":false,\"degree\":1,\"algorithm\":\"all\",\"hideColor\":\"rgba(200,200,200,0.5)\",\"labelOnly\":true},\"collapse\":{\"enabled\":false,\"fit\":false,\"resetHighlight\":true,\"clusterOptions\":null,\"keepCoord\":true,\"labelSuffix\":\"(cluster)\"},\"legend\":{\"width\":0.2,\"useGroups\":true,\"position\":\"left\",\"ncol\":1,\"stepX\":100,\"stepY\":100,\"zoom\":true}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::",
    "supporting": [
      "Catfish_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/htmlwidgets-1.6.2/htmlwidgets.js\"></script>\r\n<link href=\"../../site_libs/vis-9.1.0/vis-network.min.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/vis-9.1.0/vis-network.min.js\"></script>\r\n<script src=\"../../site_libs/visNetwork-binding-2.1.2/visNetwork.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}